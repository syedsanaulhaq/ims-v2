# üîß Environment Configuration Guide

## ‚ö†Ô∏è CRITICAL: How Environment Files Work

### The Environment File Chain

```
.env-test  ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ
.env-development ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> switch-env.ps1 ‚îÄ‚îÄ> .env ‚îÄ‚îÄ> Application
               ‚îÇ                                      (Backend + Frontend)
.env-production ‚îÄ‚îÄ‚îÄ‚îò
```

**Key Points:**
1. **Source Files** (`.env-development`, `.env-test`, `.env-production`) are version controlled
2. **Active File** (`.env`) is copied from source by `switch-env.ps1`
3. **Applications** read from `.env` only
4. **Vite** bakes `.env` variables at **build time** (not runtime!)

---

## üìÅ File Structure

```
ims-v1/
‚îú‚îÄ‚îÄ .env                    # ‚ö° ACTIVE (gitignored - generated by switch-env.ps1)
‚îú‚îÄ‚îÄ .env-development        # üìù Source for dev (committed to Git)
‚îú‚îÄ‚îÄ .env-test              # üìù Source for test (committed to Git) ‚úÖ
‚îú‚îÄ‚îÄ .env-production        # üìù Source for prod (committed to Git)
‚îú‚îÄ‚îÄ .env.backup.*          # üíæ Auto-backups (gitignored)
‚îî‚îÄ‚îÄ switch-env.ps1         # üîÑ Environment switcher script
```

---

## üéØ Test Environment Configuration

### What `.env-test` Contains

```env
# ========================================
# TEST ENVIRONMENT CONFIGURATION
# ========================================
# This file is the SOURCE for test environment
# Run: .\switch-env.ps1 test
# This will copy .env-test to .env

NODE_ENV=test
VITE_API_URL=http://localhost:5001
API_URL=http://localhost:5001
PORT=5001
FRONTEND_PORT=4173

# SQL Server Test Database
SQL_SERVER_HOST=SYED-FAZLI-LAPT
SQL_SERVER_DATABASE=InventoryManagementDB_TEST
SQL_SERVER_USER=inventoryusertest
SQL_SERVER_PASSWORD=2016Wfp61@
SQL_SERVER_PORT=1433
SQL_SERVER_ENCRYPT=false
SQL_SERVER_TRUST_CERT=true

# JWT & Security (test values)
JWT_SECRET=test-jwt-secret-2024
SESSION_SECRET=test-session-secret-2024
```

---

## üöÄ Complete Test Environment Setup

### Step 1: Create Test Database

```powershell
# Clone production database to test
sqlcmd -S localhost -U sa -P "1978Jupiter87@#" -i clone-database-with-data.sql
```

**Result:**
- Database: `InventoryManagementDB_TEST`
- Contains: 278 users, 15 items, all production data
- SQL User: `inventoryusertest` / `2016Wfp61@`

### Step 2: Switch to Test Environment

```powershell
# This copies .env-test ‚Üí .env
.\switch-env.ps1 test
```

**What This Does:**
```
[SUCCESS] Switched to test environment!
[INFO] Active file: .env-test -> .env

=== Environment Settings ===
[INFO]   Environment: test
[INFO]   Database: InventoryManagementDB_TEST
[INFO]   Backend Port: 5001
[INFO]   Frontend Port: 4173

=== Next Steps ===
[INFO] 1. Restart your backend server
[INFO] 2. Restart your frontend (if running)
[INFO] 3. Backend will connect to: InventoryManagementDB_TEST
```

### Step 3: Start Test Environment

```powershell
# Option A: One command (recommended)
npm run test:full

# This runs:
# 1. .\switch-env.ps1 test  ‚Üê Copies .env-test to .env
# 2. npm run build          ‚Üê Builds frontend with .env variables
# 3. Starts backend + frontend concurrently
```

```powershell
# Option B: Manual start
node invmis-api-server.cjs  # Backend on port 5001
npm run preview             # Frontend on port 4173
```

### Step 4: Verify Everything

```powershell
# Check active .env file
Get-Content .env | Select-String "NODE_ENV|SQL_SERVER_DATABASE|PORT|VITE_API_URL"
```

**Expected output:**
```
NODE_ENV=test
SQL_SERVER_DATABASE=InventoryManagementDB_TEST
PORT=5001
VITE_API_URL=http://localhost:5001
```

**Backend should show:**
```
‚úÖ Connected to SQL Server: InventoryManagementDB_TEST
üìä Database has 425 users
üöÄ InvMIS API Server running on port 5001
```

---

## üîÑ Environment Switching Workflow

### Development Environment

```powershell
# Switch to dev
.\switch-env.ps1 dev
npm run dev:full

# Uses: .env-development
# Database: InventoryManagementDB (production)
# Ports: 3001 (backend), 8080 (frontend)
```

### Test Environment (For Boss Presentation)

```powershell
# Switch to test
.\switch-env.ps1 test
npm run test:full

# Uses: .env-test ‚úÖ
# Database: InventoryManagementDB_TEST (production clone)
# Ports: 5001 (backend), 4173 (frontend)
```

### Production Environment

```powershell
# Switch to production
.\switch-env.ps1 prod
npm run prod:full

# Uses: .env-production
# Database: InventoryManagementDB (production)
# Ports: 5000 (backend), 80 (frontend)
```

---

## ‚ö° NPM Scripts Explained

| Script | Environment File | What It Does |
|--------|-----------------|--------------|
| `npm run dev:full` | Uses current `.env` | Starts dev without switching |
| `npm run test:full` | Switches to `.env-test` | **Copies .env-test ‚Üí .env, builds, starts** ‚úÖ |
| `npm run prod:full` | Switches to `.env-production` | Copies .env-production ‚Üí .env, builds, starts |
| `npm run switch:dev` | Copies `.env-development` | Only switches, doesn't start |
| `npm run switch:test` | Copies `.env-test` | Only switches, doesn't start |
| `npm run switch:prod` | Copies `.env-production` | Only switches, doesn't start |

---

## üêõ Troubleshooting

### Problem 1: Wrong Database Connection

**Symptoms:**
```
‚úÖ Connected to SQL Server: InventoryManagementDB
                            ^^^^^^^^^^^^^^^^^^^ Wrong! Should be _TEST
```

**Cause:** `.env` still has old values

**Solution:**
```powershell
# Re-run environment switch
.\switch-env.ps1 test

# Verify
Get-Content .env | Select-String "SQL_SERVER_DATABASE"
# Should show: SQL_SERVER_DATABASE=InventoryManagementDB_TEST

# Restart backend
taskkill /f /im node.exe
node invmis-api-server.cjs
```

### Problem 2: Frontend API URL Wrong

**Symptoms:**
```javascript
// Browser console shows:
TypeError: Failed to fetch
GET https://api.yourdomain.com/api/session
    ^^^^^^^^^^^^^^^^^^^^^^^ Wrong! Should be localhost:5001
```

**Cause:** Frontend built BEFORE switching to test environment

**Solution:**
```powershell
# Kill processes
taskkill /f /im node.exe

# Rebuild with correct environment
npm run test:full
# This will:
# 1. Copy .env-test ‚Üí .env
# 2. Build frontend (VITE_API_URL=http://localhost:5001 baked in)
# 3. Start both servers
```

### Problem 3: Environment Changes Not Taking Effect

**Symptoms:** Changed `.env` but nothing updates

**Root Cause:** **Vite bakes environment variables at BUILD time!**

**Solution:**
```powershell
# You MUST rebuild after ANY .env changes
npm run build

# Then restart
npm run preview
```

---

## üìä Environment Comparison Table

| Setting | Development (.env-development) | Test (.env-test) ‚úÖ | Production (.env-production) |
|---------|--------------------------------|---------------------|------------------------------|
| **Active After** | `.\switch-env.ps1 dev` | `.\switch-env.ps1 test` | `.\switch-env.ps1 prod` |
| **Copied To** | `.env` | `.env` | `.env` |
| **Database** | InventoryManagementDB | InventoryManagementDB_TEST | InventoryManagementDB |
| **SQL User** | Windows Auth | inventoryusertest | (production SQL user) |
| **Backend Port** | 3001 | 5001 | 5000 |
| **Frontend Port** | 8080 | 4173 | 80 |
| **API URL** | http://localhost:3001 | http://localhost:5001 | https://api.yourdomain.com |
| **NODE_ENV** | development | test | production |
| **Use Case** | Daily development | Boss presentation / Testing | Live deployment |

---

## üéØ Quick Reference Commands

### For Test Environment (Boss Presentation)

```powershell
# Setup once
sqlcmd -S localhost -U sa -P "1978Jupiter87@#" -i clone-database-with-data.sql

# Every time you present
taskkill /f /im node.exe               # Kill old processes
npm run test:full                      # Switch to .env-test, build, start
start http://localhost:4173            # Open browser
```

### Check Current Environment

```powershell
# See which environment is active
Get-Content .env | Select-String "NODE_ENV|SQL_SERVER_DATABASE"

# Should show for test:
# NODE_ENV=test
# SQL_SERVER_DATABASE=InventoryManagementDB_TEST
```

### Verify Backend Connection

```powershell
# Start backend and check console output
node invmis-api-server.cjs

# Should show:
# ‚úÖ Connected to SQL Server: InventoryManagementDB_TEST
# üìä Database has 425 users
# üöÄ InvMIS API Server running on port 5001
```

---

## ‚úÖ Pre-Presentation Checklist

- [ ] Test database created: `InventoryManagementDB_TEST`
- [ ] `.env-test` file configured correctly
- [ ] Run `.\switch-env.ps1 test` successfully
- [ ] Verify `.env` contains test settings: `Get-Content .env`
- [ ] Backend connects to `InventoryManagementDB_TEST` (check console)
- [ ] Frontend built AFTER environment switch
- [ ] Login works at http://localhost:4173
- [ ] Browser console shows API calls to http://localhost:5001 (not https://api.yourdomain.com)
- [ ] All features working (inventory, tenders, deliveries, etc.)

---

## üé¨ Presentation Day Commands

```powershell
# Clean slate
taskkill /f /im node.exe

# Start test environment
# This automatically:
# 1. Copies .env-test ‚Üí .env
# 2. Builds frontend with test settings
# 3. Starts backend (port 5001) + frontend (port 4173)
npm run test:full

# Wait 30-60 seconds for build + startup

# Open browser
start http://localhost:4173

# Login and present! üéâ
```

---

## üí° Understanding the Flow

```
1. You run: npm run test:full

2. Script executes:
   .\switch-env.ps1 test  ‚Üê Copies .env-test to .env
   
3. Now .env contains:
   NODE_ENV=test
   VITE_API_URL=http://localhost:5001
   SQL_SERVER_DATABASE=InventoryManagementDB_TEST
   
4. Build runs:
   npm run build  ‚Üê Vite bakes VITE_API_URL into JavaScript
   
5. Servers start:
   - Backend reads .env, connects to InventoryManagementDB_TEST
   - Frontend serves built files with http://localhost:5001 API URL
   
6. You present:
   - Frontend at http://localhost:4173
   - Backend at http://localhost:5001
   - Database: InventoryManagementDB_TEST
   - All using .env-test settings! ‚úÖ
```

---

## üîí Important Notes

1. **`.env` is gitignored** - It's generated, not committed
2. **`.env-test` is committed** - It's the source of truth for test environment
3. **Always use `switch-env.ps1`** - Don't manually copy files
4. **Rebuild after switch** - Frontend needs rebuild to pick up new API URLs
5. **One environment at a time** - `.env` can only hold one environment's settings

---

## üÜò Still Having Issues?

1. **Check `.env` file exists and contains test settings**
   ```powershell
   Test-Path .env
   Get-Content .env
   ```

2. **Verify test database exists**
   ```powershell
   sqlcmd -S localhost -U inventoryusertest -P "2016Wfp61@" -Q "SELECT @@SERVERNAME, DB_NAME()"
   ```

3. **Kill all node processes and restart**
   ```powershell
   taskkill /f /im node.exe
   npm run test:full
   ```

4. **Check for typos in `.env-test`**
   - Make sure no extra spaces
   - Port numbers are correct
   - Database name matches

---

**Remember: TEST ENVIRONMENT = `.env-test` (source) ‚Üí `.env` (active) ‚Üí Application**

When someone asks "which environment file for test?", the answer is:
- **Source**: `.env-test` (committed to Git)
- **Active**: `.env` (copied from `.env-test` by `switch-env.ps1`)
- **Command**: `npm run test:full` (does the copy + build + start)
